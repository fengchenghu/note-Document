### 值周
- 管理后台字段审批
	注意事项： 已上线应用新加字段 无特别情况通过
	
- 新应用审批
	注意事项： 数据量与qps小直接通过， 数据量与qps过大，需仔细确认   500qps 谨慎
	流程： 审核通过---> 部署 ---> 上线 ---> 用户添加scf调用方 ---> 审批服务管理平台工单
- 服务管理平台调用方审批
	注意事项：注意调用的调用量qpm 计算 qps大小
### 用户问题答疑
- 排序插件： 
	排序表达式 排序打分底层使用 无符号64位整形 所有溢出排序表达式所计算得到的分数
	不能是负数 也不能 过大导致溢出
	排序表达式管理员配置需点击保存配置方可生效
- 字段一旦申请通过不能改动，只能重新申请新字段
- 云搜在分词时会进行同义词扩展 例如
	西安健康管理师培训
		管理处	培训班	工		辅导		师	管理	管理员
		健康师	训师		培训生	西安市	健康	员	西安
		管理师	管理部	管理工	培训		培训员

	查 卡夫卡 流水 去卡夫卡机器	kafka：  10.136.196.194  10.136.196.196   10.136.196.198  
	/opt/esearch/kafka_cluster/kafka-logs
	grep -ar 'primarykey_id":1155742175720386560' wcs_1031804757804613633_inst-*  查找以appid作为文件名的 主键id相关信息
	cat out.2019-08-01-16 | grep appid | grep 主键id    在四台日志机挨个查找
	文档id % 分片数 = 所在的分片  去分片searcher build日志中查找帖子信息
	进入searcher容器中 	/home/work/esearch/package/index_look ./indexerdata/data/288/	这个数字挨个试 6是根据文档id查看信息
	
- 某条query查询不出结果，去掉某个条件后查询成功，并且去掉的条件确实存在 索引正排都对，可能是由于副本间数据不一致导致，由于同一条query会哈希到一个副本上，所以查询失败
	query： appid=1122322032462180352&houseId=1059645660684289&set58=1&state=2|1&page=1&size=20&sort=updateTime_desc&abstractfields=houseId,cityId,set58,state
	现象：	去掉&set58=1 条件查询成功但摘要和正排都显示set58=1   查询索引量发现副本间数据不一致 
			进入searcher容器中 挨个副本 使用内核工具发送query 查看返回结果，发现某个副本返回无结果
	解决方法： 由于qps较低直接对数据不一致的副本进行删除，使得query无法哈希到该副本，哈希到其他副本返回结果，对于qps较高的 可以采取先扩容然后删除有问题的副本解决
	内核工具使用： 							forceLog： 是否记录日志		
		cd /home/work/esearch/package;
		./single_query_searcher_client tcp:`hostname -i`:20022 'query=!(wcsdocid:(-1))&&sort=fields(wcsdocid:desc)&&config=start:0,rows:35,timeout:1000,forceLog:true&&uuid=yangchao&&fields=wcsdocid&&imFilter=null&&check=' false
		内核会返回查询结果
		老内核不用加false  新内核要加false 
		
- 某条query查询不出结果， 但根据主键查摘要显示有数据，可能是由于数据丢失所致
	case： appid=1099858400226889731&houseId=1069332580588544   查询无结果  查摘要有数据
	排查步骤： 查看kafka日志 未找到此条数据相关信息， 查看日志机indexproxy日志找到发送记录，怀疑数据丢失
	解决方法： 重建版本，重新 索引 数据，新建版本--->部署--->预热--->灰度--->上线
	
- 不能按照主键范围查询 ，其他数值字段可以
- 应用下线要用户主动发起申请，强制下线需要手动修改数据库search_app表中的state字段
- 新建一个版本会拉取全量索引，内存CPU都会升高   
	/home/work/esearch/package/indexer  /opt/esearch/searcher/data/indexerdata		全量索引构建

	
### pod 一直处于init状态
	
- 进入初始化容器 中查看日志   
	可用kubectl logs podname  得到提示的container name  然后使用 -c 容器名 进入
	kubectl -n wcs-test exec -it appid1051669005242228736-searcher-shard0-deploy-7454d9779bqsx4r -c app1051669005242228736-shard0-indexer-init-container bash
- searcher  如果有多个副本，在新创建一个pod副本时，会从其他副本scp  copy 索引文件  如果没有其他副本 会全量拉取数据
	初始化容器app1049870420825628672-shard0-indexer-init-container
	脚本perl /home/work/esearch/package/dockerlize/tools/docker-entrypoint.pl 的作用：
	就是支持其他副本远端ssh 来scp 索引文件  和  从其他副本ssh scp 索引文件
	
- 云搜语法
	支持数字 或一个数字范围
		city_id=0|100_900    
	文本字段或查询，必须带括号，数字字段或查询 可以 直接或一个字段
		appid=1153515524873826305&((format=EPS)||(format=AI))
		appid=1153515524873826305&id=1156859502587330560|1156858486009679872

		
		
		
		
- 在容器中执行命令TERM environment variable not set时   使用 export TERM=xterm
- 强制删除kubernetes 资源对象 后加参数 --force --grace-period=0


- 容器 使用ssh 其他副本pod ssh work@ip 密码为work      可以执行远程命令  scp拷贝索引文件等

- 使用kubectl 以json方式获取指定的数据
	获取所有容器的名字
	kubectl -n wcs-test get deployment/appid1156850434837602304-v1-searcher-shard0-deploy -o=jsonpath='{.spec.template.spec.containers[*].name}{.spec.template.spec.initContainers[*].name}'
	
	
### 异常查看
- 服务管理平台查看异常量 进入机器查看机器具体情况 跳到机器下查看日志 
- 在某台机器上查看所有出问题的pod及其副本日志
    ```
    // 替换labelSelector=name%3Dwcsrouteproxy-index-proxy,...  使用label过滤 
       qx 在Perl 中为执行外部程序
       grep 
            -n   显示行号
            -A n 是显示匹配后和它后面的n行。 
            -B n 是显示匹配行和它前面的n行。 
            -C n 是匹配行和它前后各n行。
       $F[n]  
            jq输出后的数组元素，正数 0 1 2 ...  倒数 -1 -2 -3 ...

    curl -s http://apiserver:3218/api/v1/namespaces/wcs-online/pods?labelSelector=[label1]=[label2] | jq -r '.items | map([.metadata.name,.status.podIP,.status.hostIP,.spec.nodeName])' | jq -r '.[] | @tsv' | perl -lane 'my ($pod, $podip, $ip, $host, $log_path) = ($F[0], $F[-3],$F[-2], $F[-1], "pod内部日志文件路径"); print "$pod:$ip:$log_path\n", qx{kubectl -n wcs-online exec -i $pod -c 替换为容器名 -- bash -c  "grep -n 19:55: -A 1 $log_path"}' > /opt/fengchenghu/pod_2line.txt
    
    ```

### case
- 2019-08-26 业务方反馈 indexproxy速度变慢，进入具体节点发现下沉proxy tjtx136-196-94.58os.org 的服务耗时高达几百ms
    日志表现： java.lang.IllegalArgumentException: unresolved address
    处理方法： 将此机器节点从服务管理平台分组踢掉
    原因：     kube-system 命名空间下dns 服务pod 共有三个节点 有两个节点网络不通 ping 包全部丢掉
    
